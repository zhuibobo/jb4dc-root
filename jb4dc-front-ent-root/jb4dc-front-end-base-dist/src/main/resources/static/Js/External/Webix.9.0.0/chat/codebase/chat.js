/*
@license
Webix <%= pkg.productName %> v.<%= pkg.version %>
This software is covered by Webix Trial License.
Usage without proper license is prohibited.
(c) XB Software Ltd.
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).chat={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,i)};function i(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}var n=function(){return(n=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},a=function(){},r=function(){function t(t,e){this.webixJet=!0,this.webix=t,this._events=[],this._subs={},this._data={},e&&e.params&&t.extend(this._data,e.params)}return t.prototype.getRoot=function(){return this._root},t.prototype.destructor=function(){this._detachEvents(),this._destroySubs(),this._events=this._container=this.app=this._parent=this._root=null},t.prototype.setParam=function(t,e,i){if(this._data[t]!==e&&(this._data[t]=e,this._segment.update(t,e,0),i))return this.show(null)},t.prototype.getParam=function(t,e){var i=this._data[t];if(void 0!==i||!e)return i;var n=this.getParentView();return n?n.getParam(t,e):void 0},t.prototype.getUrl=function(){return this._segment.suburl()},t.prototype.getUrlString=function(){return this._segment.toString()},t.prototype.getParentView=function(){return this._parent},t.prototype.$$=function(t){if("string"==typeof t){var e=this.getRoot();return e.queryView((function(i){return(i.config.id===t||i.config.localId===t)&&i.$scope===e.$scope}),"self")}return t},t.prototype.on=function(t,e,i){var n=t.attachEvent(e,i);return this._events.push({obj:t,id:n}),n},t.prototype.contains=function(t){for(var e in this._subs){var i=this._subs[e].view;if(i===t||i.contains(t))return!0}return!1},t.prototype.getSubView=function(t){var e=this.getSubViewInfo(t);if(e)return e.subview.view},t.prototype.getSubViewInfo=function(t){var e=this._subs[t||"default"];return e?{subview:e,parent:this}:"_top"===t?(this._subs[t]={url:"",id:null,popup:!0},this.getSubViewInfo(t)):this._parent?this._parent.getSubViewInfo(t):null},t.prototype._detachEvents=function(){for(var t=this._events,e=t.length-1;e>=0;e--)t[e].obj.detachEvent(t[e].id)},t.prototype._destroySubs=function(){for(var t in this._subs){var e=this._subs[t].view;e&&e.destructor()}this._subs={}},t.prototype._init_url_data=function(){var t=this._segment.current();this._data={},this.webix.extend(this._data,t.params,!0)},t.prototype._getDefaultSub=function(){if(this._subs.default)return this._subs.default;for(var t in this._subs){var e=this._subs[t];if(!e.branch&&e.view&&"_top"!==t){var i=e.view._getDefaultSub();if(i)return i}}},t.prototype._routed_view=function(){var t=this.getParentView();if(!t)return!0;var e=t._getDefaultSub();return!(!e&&e!==this)&&t._routed_view()},t}();function o(t){"/"===t[0]&&(t=t.substr(1));for(var e=t.split("/"),i=[],n=0;n<e.length;n++){var a=e[n],r={},o=a.indexOf(":");if(-1===o&&(o=a.indexOf("?")),-1!==o)for(var s=0,c=a.substr(o+1).split(/[\:\?\&]/g);s<c.length;s++){var u=c[s].split("=");r[u[0]]=decodeURIComponent(u[1])}i[n]={page:o>-1?a.substr(0,o):a,params:r,isNew:!0}}return i}function s(t){for(var e=[],i=0,n=t;i<n.length;i++){var a=n[i];e.push("/"+a.page);var r=c(a.params);r&&e.push("?"+r)}return e.join("")}function c(t){var e=[];for(var i in t)"object"!=typeof t[i]&&(e.length&&e.push("&"),e.push(i+"="+encodeURIComponent(t[i])));return e.join("")}var u=function(){function t(t,e){this._next=1,this.route="string"==typeof t?{url:o(t),path:t}:t,this.index=e}return t.prototype.current=function(){return this.route.url[this.index]},t.prototype.next=function(){return this.route.url[this.index+this._next]},t.prototype.suburl=function(){return this.route.url.slice(this.index)},t.prototype.shift=function(e){var i=new t(this.route,this.index+this._next);return i.setParams(i.route.url,e,i.index),i},t.prototype.setParams=function(t,e,i){if(e){var n=t[i].params;for(var a in e)n[a]=e[a]}},t.prototype.refresh=function(){for(var t=this.route.url,e=this.index+1;e<t.length;e++)t[e].isNew=!0},t.prototype.toString=function(){var t=s(this.suburl());return t?t.substr(1):""},t.prototype._join=function(t,e){var i=this.route.url;if(null===t)return i;var n=this.route.url,a=!0;if(i=n.slice(0,this.index+(e?this._next:0)),t){i=i.concat(o(t));for(var r=0;r<i.length;r++)n[r]&&(i[r].view=n[r].view),a&&n[r]&&i[r].page===n[r].page?i[r].isNew=!1:i[r].isNew&&(a=!1)}return i},t.prototype.append=function(t){var e=this._join(t,!0);return this.route.path=s(e),this.route.url=e,this.route.path},t.prototype.show=function(t,e,i){var n=this,r=this._join(t.url,i);return this.setParams(r,t.params,this.index+(i?this._next:0)),new Promise((function(t,i){var o=s(r),c={url:r,redirect:o,confirm:Promise.resolve()},u=e?e.app:null;if(u&&!u.callEvent("app:guard",[c.redirect,e,c]))return void i(new a);c.confirm.catch((function(t){return i(t)})).then((function(){if(null!==c.redirect){if(c.redirect!==o)return u.show(c.redirect),void i(new a);n.route.path=o,n.route.url=r,t()}else i(new a)}))}))},t.prototype.size=function(t){this._next=t},t.prototype.split=function(){var e={url:this.route.url.slice(this.index+1),path:""};return e.url.length&&(e.path=s(e.url)),new t(e,0)},t.prototype.update=function(t,e,i){var n=this.route.url[this.index+(i||0)];if(!n)return this.route.url.push({page:"",params:{}}),this.update(t,e,i);""===t?n.page=e:n.params[t]=e,this.route.path=s(this.route.url)},t}(),h=function(t){function e(e,i){var n=t.call(this,e.webix)||this;return n.app=e,n._children=[],n}return i(e,t),e.prototype.ui=function(t,e){var i=(e=e||{}).container||t.container,n=this.app.createView(t);return this._children.push(n),n.render(i,this._segment,this),"object"!=typeof t||t instanceof r?n:n.getRoot()},e.prototype.show=function(t,e){if(e=e||{},"object"==typeof t){for(var i in t)this.setParam(i,t[i]);t=null}else{if("/"===t.substr(0,1))return this.app.show(t,e);if(0===t.indexOf("./")&&(t=t.substr(2)),0===t.indexOf("../")){var n=this.getParentView();return n?n.show(t.substr(3),e):this.app.show("/"+t.substr(3))}var a=this.getSubViewInfo(e.target);if(a){if(a.parent!==this)return a.parent.show(t,e);if(e.target&&"default"!==e.target)return this._renderFrameLock(e.target,a.subview,{url:t,params:e.params})}else if(t)return this.app.show("/"+t,e)}return this._show(this._segment,{url:t,params:e.params},this)},e.prototype._show=function(t,e,i){var n=this;return t.show(e,i,!0).then((function(){return n._init_url_data(),n._urlChange()})).then((function(){t.route.linkRouter&&(n.app.getRouter().set(t.route.path,{silent:!0}),n.app.callEvent("app:route",[t.route.path]))}))},e.prototype.init=function(t,e){},e.prototype.ready=function(t,e){},e.prototype.config=function(){this.app.webix.message("View:Config is not implemented")},e.prototype.urlChange=function(t,e){},e.prototype.destroy=function(){},e.prototype.destructor=function(){this.destroy(),this._destroyKids(),this._root&&(this._root.destructor(),t.prototype.destructor.call(this))},e.prototype.use=function(t,e){t(this.app,this,e)},e.prototype.refresh=function(){this.getUrl();return this.destroy(),this._destroyKids(),this._destroySubs(),this._detachEvents(),this._container.tagName&&this._root.destructor(),this._segment.refresh(),this._render(this._segment)},e.prototype.render=function(t,e,i){var n=this;"string"==typeof e&&(e=new u(e,0)),this._segment=e,this._parent=i,this._init_url_data();var a="string"==typeof(t=t||document.body)?this.webix.toNode(t):t;return this._container!==a?(this._container=a,this._render(e)):this._urlChange().then((function(){return n.getRoot()}))},e.prototype._render=function(t){var e=this,i=this.config();return i.then?i.then((function(i){return e._render_final(i,t)})):this._render_final(i,t)},e.prototype._render_final=function(t,e){var i,n=this,a=null,r=null,o=!1;if(this._container.tagName?r=this._container:(a=this._container).popup?(r=document.body,o=!0):r=this.webix.$$(a.id),!this.app||!r)return Promise.reject(null);var s=this._segment.current(),c={ui:{}};this.app.copyConfig(t,c.ui,this._subs),this.app.callEvent("app:render",[this,e,c]),c.ui.$scope=this,!a&&s.isNew&&s.view&&s.view.destructor();try{if(a&&!o){var u=r,h=u.getParentView();h&&"multiview"===h.name&&!c.ui.id&&(c.ui.id=u.config.id)}this._root=this.app.webix.ui(c.ui,r);var l=this._root;o&&l.setPosition&&!l.isVisible()&&l.show(),a&&(a.view&&a.view!==this&&a.view!==this.app&&a.view.destructor(),a.id=this._root.config.id,this.getParentView()||!this.app.app?a.view=this:a.view=this.app),s.isNew&&(s.view=this,s.isNew=!1),i=Promise.resolve(this._init(this._root,e)).then((function(){return n._urlChange().then((function(){return n._initUrl=null,n.ready(n._root,e.suburl())}))}))}catch(t){i=Promise.reject(t)}return i.catch((function(t){return n._initError(n,t)}))},e.prototype._init=function(t,e){return this.init(t,e.suburl())},e.prototype._urlChange=function(){var t=this;this.app.callEvent("app:urlchange",[this,this._segment]);var e=[];for(var i in this._subs){var n=this._subs[i],a=this._renderFrameLock(i,n,null);a&&e.push(a)}return Promise.all(e).then((function(){return t.urlChange(t._root,t._segment.suburl())}))},e.prototype._renderFrameLock=function(t,e,i){if(!e.lock){var n=this._renderFrame(t,e,i);n&&(e.lock=n.then((function(){return e.lock=null}),(function(){return e.lock=null})))}return e.lock},e.prototype._renderFrame=function(t,e,i){var n=this;if("default"===t){if(this._segment.next()){var a=i?i.params:null;return e.params&&(a=this.webix.extend(a||{},e.params)),this._createSubView(e,this._segment.shift(a))}e.view&&e.popup&&(e.view.destructor(),e.view=null)}if(null!==i&&(e.url=i.url,e.params&&(i.params=this.webix.extend(i.params||{},e.params))),e.route){if(null!==i)return e.route.show(i,e.view).then((function(){return n._createSubView(e,e.route)}));if(e.branch)return}var r=e.view;if(!r&&e.url){if("string"==typeof e.url)return e.route=new u(e.url,0),i&&e.route.setParams(e.route.route.url,i.params,0),e.params&&e.route.setParams(e.route.route.url,e.params,0),this._createSubView(e,e.route);"function"!=typeof e.url||r instanceof e.url||(r=new(this.app._override(e.url))(this.app,"")),r||(r=e.url)}if(r)return r.render(e,e.route||this._segment,this)},e.prototype._initError=function(t,e){return this.app&&this.app.error("app:error:initview",[e,t]),!0},e.prototype._createSubView=function(t,e){var i=this;return this.app.createFromURL(e.current()).then((function(n){return n.render(t,e,i)}))},e.prototype._destroyKids=function(){for(var t=this._children,e=t.length-1;e>=0;e--)t[e]&&t[e].destructor&&t[e].destructor();this._children=[]},e}(r),l=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n._ui=i.ui,n}return i(e,t),e.prototype.config=function(){return this._ui},e}(h),p=function(){function t(t,e,i){this.path="",this.app=i}return t.prototype.set=function(t,e){this.path=t;var i=this.app;i.app.getRouter().set(i._segment.append(this.path),{silent:!0})},t.prototype.get=function(){return this.path},t}(),f=!0,d=function(t){function e(e){var i=this,n=(e||{}).webix||window.webix;return e=n.extend({name:"App",version:"1.0",start:"/home"},e,!0),(i=t.call(this,n,e)||this).config=e,i.app=i.config.app,i.ready=Promise.resolve(),i._services={},i.webix.extend(i,i.webix.EventSystem),i}return i(e,t),e.prototype.getUrl=function(){return this._subSegment.suburl()},e.prototype.getUrlString=function(){return this._subSegment.toString()},e.prototype.getService=function(t){var e=this._services[t];return"function"==typeof e&&(e=this._services[t]=e(this)),e},e.prototype.setService=function(t,e){this._services[t]=e},e.prototype.destructor=function(){this.getSubView().destructor(),t.prototype.destructor.call(this)},e.prototype.copyConfig=function(t,e,i){if((t instanceof r||"function"==typeof t&&t.prototype instanceof r)&&(t={$subview:t}),void 0!==t.$subview)return this.addSubView(t,e,i);var n=t instanceof Array;for(var a in e=e||(n?[]:{}),t){var o=t[a];if("function"==typeof o&&o.prototype instanceof r&&(o={$subview:o}),!o||"object"!=typeof o||o instanceof this.webix.DataCollection||o instanceof RegExp||o instanceof Map)e[a]=o;else if(o instanceof Date)e[a]=new Date(o);else{var s=this.copyConfig(o,o instanceof Array?[]:{},i);null!==s&&(n?e.push(s):e[a]=s)}}return e},e.prototype.getRouter=function(){return this.$router},e.prototype.clickHandler=function(t,e){if(t&&(e=e||t.target||t.srcElement)&&e.getAttribute){var i=e.getAttribute("trigger");if(i)return this._forView(e,(function(t){return t.app.trigger(i)})),t.cancelBubble=!0,t.preventDefault();var n=e.getAttribute("route");if(n)return this._forView(e,(function(t){return t.show(n)})),t.cancelBubble=!0,t.preventDefault()}var a=e.parentNode;a&&this.clickHandler(t,a)},e.prototype.getRoot=function(){return this.getSubView().getRoot()},e.prototype.refresh=function(){var t=this;return this._subSegment?this.getSubView().refresh().then((function(e){return t.callEvent("app:route",[t.getUrl()]),e})):Promise.resolve(null)},e.prototype.loadView=function(t){var e=this,i=this.config.views,n=null;if(""===t)return Promise.resolve(this._loadError("",new Error("Webix Jet: Empty url segment")));try{i&&"string"==typeof(n="function"==typeof i?i(t):i[t])&&(t=n,n=null),n||("_hidden"===t?n={hidden:!0}:"_blank"===t?n={}:(t=t.replace(/\./g,"/"),n=this.require("jet-views",t)))}catch(e){n=this._loadError(t,e)}return n.then||(n=Promise.resolve(n)),n=n.then((function(t){return t.__esModule?t.default:t})).catch((function(i){return e._loadError(t,i)}))},e.prototype._forView=function(t,e){var i=this.webix.$$(t);i&&e(i.$scope)},e.prototype._loadViewDynamic=function(t){return null},e.prototype.createFromURL=function(t){var e=this;return t.isNew||!t.view?this.loadView(t.page).then((function(i){return e.createView(i,name,t.params)})):Promise.resolve(t.view)},e.prototype._override=function(t){var e=this.config.override;if(e){for(var i=void 0;t;)i=t,t=e.get(t);return i}return t},e.prototype.createView=function(t,i,n){if("function"==typeof(t=this._override(t))){if(t.prototype instanceof e)return new t({app:this,name:i,params:n,router:p});if(t.prototype instanceof r)return new t(this,{name:i,params:n});t=t(this)}return t instanceof r?t:new l(this,{name:i,ui:t})},e.prototype.show=function(t,e){return t&&this.app&&0==t.indexOf("//")?this.app.show(t.substr(1),e):this.render(this._container,t||this.config.start,e)},e.prototype.trigger=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this.apply(t,e)},e.prototype.apply=function(t,e){this.callEvent(t,e)},e.prototype.action=function(t){return this.webix.bind((function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.apply(t,e)}),this)},e.prototype.on=function(t,e){this.attachEvent(t,e)},e.prototype.use=function(t,e){t(this,null,e)},e.prototype.error=function(t,e){if(this.callEvent(t,e),this.callEvent("app:error",e),this.config.debug)for(var i=0;i<e.length;i++)if(console.error(e[i]),e[i]instanceof Error){var n=e[i].message;0===n.indexOf("Module build failed")?(n=n.replace(/\x1b\[[0-9;]*m/g,""),document.body.innerHTML="<pre style='font-size:16px; background-color: #ec6873; color: #000; padding:10px;'>"+n+"</pre>"):(n+="<br><br>Check console for more details",this.webix.message({type:"error",text:n,expire:-1}))}},e.prototype.render=function(t,e,i){var n=this;this._container="string"==typeof t?this.webix.toNode(t):t||document.body;var a=null;!this.$router?(f&&"tagName"in this._container&&(this.webix.event(document.body,"click",(function(t){return n.clickHandler(t)})),f=!1),"string"==typeof e&&(e=new u(e,0)),this._subSegment=this._first_start(e),this._subSegment.route.linkRouter=!0):a="string"==typeof e?e:this.app?e.split().route.path||this.config.start:e.toString();var r=i?i.params:this.config.params||null,o=this.getSubView(),s=this._subSegment,c=s.show({url:a,params:r},o).then((function(){return n.createFromURL(s.current())})).then((function(e){return e.render(t,s)})).then((function(t){return n.$router.set(s.route.path,{silent:!0}),n.callEvent("app:route",[n.getUrl()]),t}));return this.ready=this.ready.then((function(){return c})),c},e.prototype.getSubView=function(){if(this._subSegment){var t=this._subSegment.current().view;if(t)return t}return new h(this,{})},e.prototype.require=function(t,e){return null},e.prototype._first_start=function(t){var e=this;this._segment=t;if(this.$router=new this.config.router((function(t){return setTimeout((function(){e.show(t).catch((function(t){if(!(t instanceof a))throw t}))}),1)}),this.config,this),this._container===document.body&&!1!==this.config.animation){var i=this._container;this.webix.html.addCss(i,"webixappstart"),setTimeout((function(){e.webix.html.removeCss(i,"webixappstart"),e.webix.html.addCss(i,"webixapp")}),10)}if(t){if(this.app){var n=t.current().view;t.current().view=this,t.next()?(t.refresh(),t=t.split()):t=new u(this.config.start,0),t.current().view=n}}else{var r=this.$router.get();r||(r=this.config.start,this.$router.set(r,{silent:!0})),t=new u(r,0)}return t},e.prototype._loadError=function(t,e){return this.error("app:error:resolve",[e,t]),{template:" "}},e.prototype.addSubView=function(t,e,i){var n=!0!==t.$subview?t.$subview:null,a=t.name||(n?this.webix.uid():"default");return e.id=t.id||"s"+this.webix.uid(),(i[a]={id:e.id,url:n,branch:t.branch,popup:t.popup,params:t.params}).popup?null:e},e}(r),v=function(){function t(t,e){var i=this;this.config=e||{},this._detectPrefix(),this.cb=t,window.onpopstate=function(){return i.cb(i.get())}}return t.prototype.set=function(t,e){var i=this;if(this.config.routes){var n=t.split("?",2);for(var a in this.config.routes)if(this.config.routes[a]===n[0]){t=a+(n.length>1?"?"+n[1]:"");break}}this.get()!==t&&window.history.pushState(null,null,this.prefix+this.sufix+t),e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){var t=this._getRaw().replace(this.prefix,"").replace(this.sufix,"");if(t="/"!==t&&"#"!==t?t:"",this.config.routes){var e=t.split("?",2),i=this.config.routes[e[0]];i&&(t=i+(e.length>1?"?"+e[1]:""))}return t},t.prototype._detectPrefix=function(){var t=this.config.routerPrefix;this.sufix="#"+(void 0===t?"!":t),this.prefix=document.location.href.split("#",2)[0]},t.prototype._getRaw=function(){return document.location.href},t}(),m=!1;function g(t){if(!m&&t){m=!0;var e=window;e.Promise||(e.Promise=t.promise);var i=t.version.split(".");10*i[0]+1*i[1]<53&&(t.ui.freeze=function(e){var i=e();return i&&i.then?i.then((function(e){return t.ui.$freeze=!1,t.ui.resize(),e})):(t.ui.$freeze=!1,t.ui.resize()),i});var n=t.ui.baselayout.prototype.addView,a=t.ui.baselayout.prototype.removeView,r={addView:function(t,e){if(this.$scope&&this.$scope.webixJet&&!t.queryView){var i=this.$scope,a={};t=i.app.copyConfig(t,{},a),n.apply(this,[t,e]);var r=function(t){i._renderFrame(t,a[t],null).then((function(){i._subs[t]=a[t]}))};for(var o in a)r(o);return t.id}return n.apply(this,arguments)},removeView:function(){if(a.apply(this,arguments),this.$scope&&this.$scope.webixJet){var e=this.$scope._subs;for(var i in e){var n=e[i];t.$$(n.id)||(n.view.destructor(),delete e[i])}}}};t.extend(t.ui.layout.prototype,r,!0),t.extend(t.ui.baselayout.prototype,r,!0),t.protoUI({name:"jetapp",$init:function(e){this.$app=new this.app(e);var i=t.uid().toString();e.body={id:i},this.$ready.push((function(){this.callEvent("onInit",[this.$app]),this.$app.render({id:i})}))}},t.ui.proxy,t.EventSystem)}}var b=function(t){function e(e){var i;return e.router=e.router||v,g((i=t.call(this,e)||this).webix),i}return i(e,t),e.prototype.require=function(t,e){return require(t+"/"+e)},e}(d),_=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}i(e,t),e.prototype._detectPrefix=function(){this.prefix="",this.sufix=this.config.routerPrefix||""},e.prototype._getRaw=function(){return document.location.pathname+(document.location.search||"")}}(v),function(){function t(t,e){this.path="",this.cb=t}return t.prototype.set=function(t,e){var i=this;this.path=t,e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){return this.path},t}());function w(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function y(t,e,i){for(var n in t)w(t,n)&&e.call(i||t,t[n],n,t)}function x(t){t="Warning: "+t,"undefined"!=typeof console&&console.error(t);try{throw new Error(t)}catch(t){}}var S=String.prototype.replace,C=String.prototype.split,k=function(t){var e=t%10;return 11!==t&&1===e?0:2<=e&&e<=4&&!(t>=12&&t<=14)?1:2},$={arabic:function(t){if(t<3)return t;var e=t%100;return e>=3&&e<=10?3:e>=11?4:5},bosnian_serbian:k,chinese:function(){return 0},croatian:k,french:function(t){return t>1?1:0},german:function(t){return 1!==t?1:0},russian:k,lithuanian:function(t){return t%10==1&&t%100!=11?0:t%10>=2&&t%10<=9&&(t%100<11||t%100>19)?1:2},czech:function(t){return 1===t?0:t>=2&&t<=4?1:2},polish:function(t){if(1===t)return 0;var e=t%10;return 2<=e&&e<=4&&(t%100<10||t%100>=20)?1:2},icelandic:function(t){return t%10!=1||t%100==11?1:0},slovenian:function(t){var e=t%100;return 1===e?0:2===e?1:3===e||4===e?2:3}},I={arabic:["ar"],bosnian_serbian:["bs-Latn-BA","bs-Cyrl-BA","srl-RS","sr-RS"],chinese:["id","id-ID","ja","ko","ko-KR","lo","ms","th","th-TH","zh"],croatian:["hr","hr-HR"],german:["fa","da","de","en","es","fi","el","he","hi-IN","hu","hu-HU","it","nl","no","pt","sv","tr"],french:["fr","tl","pt-br"],russian:["ru","ru-RU"],lithuanian:["lt"],czech:["cs","cs-CZ","sk"],polish:["pl"],icelandic:["is"],slovenian:["sl-SL"]};function P(t){var e,i=(e={},y(I,(function(t,i){y(t,(function(t){e[t]=i}))})),e);return i[t]||i[C.call(t,/-/,1)[0]]||i.en}function M(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var A=/\$/g,E=/%\{(.*?)\}/g;function L(t,e,i,n){if("string"!=typeof t)throw new TypeError("Polyglot.transformPhrase expects argument #1 to be string");if(null==e)return t;var a=t,r=n||E,o="number"==typeof e?{smart_count:e}:e;if(null!=o.smart_count&&a){var s=C.call(a,"||||");a=(s[function(t,e){return $[P(t)](e)}(i||"en",o.smart_count)]||s[0]).replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}return a=S.call(a,r,(function(t,e){return w(o,e)&&null!=o[e]?S.call(o[e],A,"$$"):t}))}function T(t){var e=t||{};this.phrases={},this.extend(e.phrases||{}),this.currentLocale=e.locale||"en";var i=e.allowMissing?L:null;this.onMissingKey="function"==typeof e.onMissingKey?e.onMissingKey:i,this.warn=e.warn||x,this.tokenRegex=function(t){var e=t&&t.prefix||"%{",i=t&&t.suffix||"}";if("||||"===e||"||||"===i)throw new RangeError('"||||" token is reserved for pluralization');return new RegExp(M(e)+"(.*?)"+M(i),"g")}(e.interpolation)}T.prototype.locale=function(t){return t&&(this.currentLocale=t),this.currentLocale},T.prototype.extend=function(t,e){y(t,(function(t,i){var n=e?e+"."+i:i;"object"==typeof t?this.extend(t,n):this.phrases[n]=t}),this)},T.prototype.unset=function(t,e){"string"==typeof t?delete this.phrases[t]:y(t,(function(t,i){var n=e?e+"."+i:i;"object"==typeof t?this.unset(t,n):delete this.phrases[n]}),this)},T.prototype.clear=function(){this.phrases={}},T.prototype.replace=function(t){this.clear(),this.extend(t)},T.prototype.t=function(t,e){var i,n,a=null==e?{}:e;if("string"==typeof this.phrases[t])i=this.phrases[t];else if("string"==typeof a._)i=a._;else if(this.onMissingKey){n=(0,this.onMissingKey)(t,a,this.currentLocale,this.tokenRegex)}else this.warn('Missing translation for key: "'+t+'"'),n=t;return"string"==typeof i&&(n=L(i,a,this.currentLocale,this.tokenRegex)),n},T.prototype.has=function(t){return w(this.phrases,t)},T.transformPhrase=function(t,e,i){return L(t,e,i)};var V=T;var U=window.webix;U&&g(U);var R=function(t,e,i){var n=(i=i||{}).storage,a=n?n.get("lang")||"en":i.lang||"en";function r(e,r,o){r.__esModule&&(r=r.default);var c={phrases:r};i.polyglot&&t.webix.extend(c,i.polyglot);var u=s.polyglot=new V(c);if(u.locale(e),s._=t.webix.bind(u.t,u),a=e,n&&n.put("lang",a),i.webix){var h=i.webix[e];h&&t.webix.i18n.setLocale(h)}return o?Promise.resolve():t.refresh()}function o(e,n){if(!1!==i.path){var a=(i.path?i.path+"/":"")+e;r(e,t.require("jet-locales",a),n)}}var s={getLang:function(){return a},setLang:o,setLangData:r,_:null,polyglot:null};t.setService("locale",s),o(a,!0)},O=window;O.Promise||(O.Promise=O.webix.promise);var D=1;function j(t,e,i){Object.defineProperty(e,i,{get:function(){return t[i]},set:function(e){return t[i]=e}})}function H(t,e){e=e||{};var i={},n={},a=function(t,e){var a=D++;return i[a]={mask:t,handler:e},e("*"===t?n:n[t],void 0,t),a},r=[],o=!1,s=function(t,e,n,a){if(o)r.push([t,e,n,a]);else for(var s=Object.keys(i),c=0;c<s.length;c++){var u=i[s[c]];u&&("*"!==u.mask&&u.mask!==t||u.handler(n,e,t,a))}};return Object.defineProperty(n,"$changes",{value:{attachEvent:a,detachEvent:function(t){delete i[t]}},enumerable:!1,configurable:!1}),Object.defineProperty(n,"$observe",{value:a,enumerable:!1,configurable:!1}),Object.defineProperty(n,"$batch",{value:function(t){if("function"!=typeof t){var e=t;t=function(){for(var t in e)n[t]=e[t]}}for(o=!0,t(n),o=!1;r.length;){var i=r.shift();s.apply(this,i)}},enumerable:!1,configurable:!1}),Object.defineProperty(n,"$extend",{value:function(t,i){for(var a in i=i||e,t)if(t.hasOwnProperty(a)){var r=t[a];i.nested&&"object"==typeof r&&r?n[a]=H(r,i):N(n,r,a,s)}},enumerable:!1,configurable:!1}),n.$extend(t,e),n}function N(t,e,i,n){Object.defineProperty(t,i,{get:function(){return e},set:function(t){if(null===e||null===t?e!==t:e.valueOf()!=t.valueOf()){var a=e;e=t,n(i,a,t,null)}},enumerable:!0,configurable:!1})}function B(t){console.error(t)}function F(t,e,i,n){e=e||{iceServers:[{urls:"stun:turn.webix.com:5349"},{urls:"turn:turn.webix.com:5349",username:"demo",credential:"redro43a"}]};var a,r,o=new RTCPeerConnection(e),s=((r=new Promise((function(t){a=t}))).resolve=a,r),c=function(t){i(t||{action:"streams",conn:o})};o.onicecandidate=function(e){e.candidate&&t("new-ice-candidate",e.candidate)},o.ontrack=function(){c()},o.onnegotiationneeded=function(){o.createOffer().then((function(t){return o.setLocalDescription(t)})).then((function(){return t("offer",o.localDescription)})).catch(B)},o.oniceconnectionstatechange=function(){switch(o.iceConnectionState){case"closed":case"failed":u(!0)}},o.onicegatheringstatechange=function(){switch(o.signalingState){case"closed":u(!0)}};var u=function(t){o&&(o.ontrack=null,o.onremovetrack=null,o.onremovestream=null,o.onicecandidate=null,o.oniceconnectionstatechange=null,o.onsignalingstatechange=null,o.onicegatheringstatechange=null,o.onnegotiationneeded=null,o.close(),o=null),c({action:"end",final:t})},h={audio:{echoCancellation:!0,noiseSuppression:!0},video:{facingMode:"user"}};return{start:function(e,i,n){n&&t("reset","")},end:u,restart:function(){o.restartIce()},status:function(){return o&&o.remoteDescription?1:0},enable:function(t,e){var i=webix.promise.defer(),n=o.getSenders().map((function(t){return t.track||{}})).reduce((function(t,e){return t.concat(e)}),[]);return n=n.filter((function(e){return e.kind===t})),e&&!n.length?c({action:"upgrade",kind:t,promise:i}):(n.forEach((function(t){return t.enabled=e})),i.resolve()),i},onOffer:function(e){var i=new RTCSessionDescription(e);0===o.getSenders().length?o.setRemoteDescription(i).then((function(){return o.createAnswer()})).then((function(t){return o.setLocalDescription(t)})).then((function(){s.resolve(),t("answer",o.localDescription)})).catch(B):o.setRemoteDescription(i).then((function(){return o.createAnswer()})).then((function(t){return o.setLocalDescription(t)})).then((function(){t("answer",o.localDescription)})).catch(B)},onAnswer:function(t){var e=new RTCSessionDescription(t);return o.setRemoteDescription(e).then((function(){s.resolve()})).catch(B)},upgrade:function(t,e){var i;return navigator.mediaDevices.getUserMedia((i={},i[t]=h[t],i)).then((function(t){t.getTracks().forEach((function(e){return o.addTrack(e,t)})),c(),e.resolve()})).catch((function(i){e.reject(),function(t,e){if(o)switch(t.name){case"NotFoundError":webix.alert(n("Could not find your")+" "+n("audio"==e?"microphone":"camera"));break;case"SecurityError":case"PermissionDeniedError":u(!0);break;default:webix.alert(n("Error opening your")+" "+n("audio"==e?"microphone":"camera"))}}(i,t)}))},onCandidate:function(t){s.then((function(){var e=new RTCIceCandidate(t);return o.addIceCandidate(e)})).catch(B)}}}function z(t,e,i){var n=i.track;if(n){var a=n.kind,r=t[e][a],o=new MediaStream;o.addTrack(n),r.srcObject=o}}var q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){this.time=0,this.Helpers=this.app.getService("helpers"),this.Back=this.app.getService("backend"),this.callStatuses=this.Back.callStatuses,this.State=this.getParam("state",!0),this.LocalState=H({audio:!0,video:!1,remoteVideo:!1,remoteAudio:!1}),this.Initiator=this.State.callUsers[0]===this.app.config.user,this.State.callStatus===this.callStatuses.active&&(this.AfterRefresh=!0);var t=this.app.getService("local")._users;return{type:"clean",width:this.getParam("compact",!0)?0:380,rows:[{css:"webix_chat_call",localId:"fullscreen",rows:[{animate:!1,borderless:!0,cells:[this.GetAudioConfig(t),this.GetVideoConfig()]},{borderless:!0,css:"webix_chat_video webix_chat_audio",minHeight:96,gravity:1e-4,template:'\n\t\t\t\t\t\t\t\t<div style="position: relative; width: 100%; height: 100%;">\n\t\t\t\t\t\t\t\t\t<div class="webix_chat_video_remote">\n\t\t\t\t\t\t\t\t\t\t<audio autoplay></audio>\n\t\t\t\t\t\t\t\t\t\t<video autoplay playsinline></video>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="webix_chat_video_local">\n\t\t\t\t\t\t\t\t\t\t<audio autoplay></audio>\n\t\t\t\t\t\t\t\t\t\t<video autoplay playsinline></video>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t'+this.Helpers.avatar(t.getItem(this.app.config.user),"webix_chat_video_local_avatar")+"\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t",localId:"connection"},this.GetActionsConfig()]}]}},e.prototype.init=function(){var t=this,e=this.$$("connection").$view;this.localVideo=e.querySelector(".webix_chat_video_local"),this.localAvatar=e.querySelector(".webix_chat_video_local_avatar"),this.remoteVideo=e.querySelector(".webix_chat_video_remote"),this.on(this.Back.pubsub(),"signal",(function(e){var i=e.msg,n=e.type;t.AfterRefresh||(i&&(i=JSON.parse(i)),t.Phone&&t.Phone.events(n,i))})),this.on(this.app,"updateCallTime",(function(e){return t.UpdateCallTime(e)})),this.on(this.State.$changes,"callStatus",(function(e){return t.HandleCallStatusChange(e)})),this.on(this.LocalState.$changes,"remoteVideo",(function(){return t.ShowVideo()}))},e.prototype.GetAudioConfig=function(t){var e=this,i=this.app.getService("locale")._;return{localId:"audio",type:"clean",rows:[{css:"webix_chat_audio_time",localId:"audio-timer",batch:"active",height:56,template:function(){return i("Active call")+" ("+e.Helpers.normalizeTime(e.time)+")"}},{gravity:1e-4,css:"webix_chat_audio"},{height:270,css:"webix_chat_audio",template:function(){var i=t.getItem(e.State.callUsers[e.Initiator?1:0]);return e.Helpers.avatar(i,"webix_chat_call_avatar webix_chat_avatar")+"<p class='webix_chat_call_name'>"+i.name+"</p>"}},{batch:"outgoing",css:"webix_chat_audio",height:30,template:i("Ringing")},{batch:"income",css:"webix_chat_audio",height:30,template:i("Is calling you")},{batch:"income",height:42,css:"webix_chat_audio",cols:[{},{view:"button",height:0,width:86,value:i("Accept"),css:"webix_chat_accept",click:function(){return e.AcceptCall()}},{view:"button",width:86,value:i("Reject"),css:"webix_danger",click:function(){return e.RejectCall()}},{}]},{batch:"refresh",height:42,css:"webix_chat_audio",cols:[{},{view:"button",height:0,width:86,value:i("Join call"),css:"webix_chat_accept",click:function(){e.AfterRefresh=!1,e.Start(!0)}},{view:"button",width:86,value:i("End call"),css:"webix_danger",click:function(){return e.EndCall()}},{}]},{gravity:1e-4,css:"webix_chat_audio"}]}},e.prototype.GetVideoConfig=function(){var t=this;return{localId:"video",type:"clean",rows:[{css:"webix_chat_video_time",height:56,type:"clean",cols:[{localId:"video-timer",template:function(){return t.Helpers.normalizeTime(t.time)}},{view:"icon",localId:"fullscreen-icon",icon:"chi-fullscreen",click:function(){t.SetFullscreen(!t.fullscreen)}},{width:6}]}]}},e.prototype.GetActionsConfig=function(){var t=this;return{height:80,css:"webix_chat_call_actions",localId:"call-actions",rows:[{},{height:44,cols:[{},{view:"toggle",type:"icon",offIcon:"chi-video-off",onIcon:"chi-video",localId:"video-toggle",css:"webix_primary",width:44,click:function(){return t.EnableVideo(!0)}},{width:32},{view:"toggle",type:"icon",offIcon:"chi-audio-off",onIcon:"chi-audio",localId:"audio-toggle",css:"webix_primary",width:44,value:!0,click:function(){return t.EnableAudio(!0)}},{width:32},{view:"button",type:"icon",icon:"chi-hangup",css:"webix_danger",width:44,click:function(){return t.EndCall()}},{}]},{}]}},e.prototype.ControlVisibility=function(t,e,i){var n=this.$$(t);n.show(),e&&n.showBatch(e),this.$$("call-actions")[i?"show":"hide"]()},e.prototype.SetFullscreen=function(t){webix.fullscreen.exit();var e=this.$$("fullscreen-icon");e.config.icon="chi-fullscreen"+(t?"-off":""),e.refresh(),this.fullscreen=t?webix.fullscreen.set(this.$$("fullscreen"),{head:!1,css:"webix_chat_video_fullscreen"}):null},e.prototype.Start=function(t){this.AfterRefresh?this.ControlVisibility("audio","refresh",!1):(this.ControlVisibility("audio","active",!0),this.InitPhone(this.Initiator,t),this.LocalState.audio&&this.EnableAudio(),this.LocalState.video&&this.EnableVideo())},e.prototype.InitPhone=function(t,e){var i=this,a=this.$$("connection").$view.querySelectorAll("audio"),r=this.$$("connection").$view.querySelectorAll("video");this.Phone=function(t,e,i,a,r,o){r=webix.extend(r||{},{audio:!0,video:!1});var s,c={audio:!0,video:!1},u=function(t){var e=t.action,n=t.conn,a=t.final,o=t.kind,c=t.promise;"upgrade"===e?(r[o]=!0,s.upgrade(o,c)):"end"===e?(i.remote.audio.srcObject&&i.remote.audio.srcObject.getTracks().forEach((function(t){return t.stop()})),i.local.audio.srcObject&&i.local.audio.srcObject.getTracks().forEach((function(t){return t.stop()})),i.remote.video.srcObject&&i.remote.video.srcObject.getTracks().forEach((function(t){return t.stop()})),i.local.video.srcObject&&i.local.video.srcObject.getTracks().forEach((function(t){return t.stop()})),i.local.audio.removeAttribute("src"),i.local.audio.removeAttribute("srcObject"),i.remote.audio.removeAttribute("src"),i.remote.audio.removeAttribute("srcObject"),i.local.video.removeAttribute("src"),i.local.video.removeAttribute("srcObject"),i.remote.video.removeAttribute("src"),i.remote.video.removeAttribute("srcObject"),a&&i.end()):"streams"===e&&(n.getSenders().forEach((function(t){return z(i,"local",t)})),n.getReceivers().forEach((function(t){return z(i,"remote",t)})))},h=function(){return t("active",n({},c)),F(t,e,u,o)};switch(s=h(),a){case 1:s.start(r,c);break;case 2:t("await-offer","");break;case 3:s.start(r,c,!0)}return{events:function(e,a){switch(e){case"reset":s.end(),s=h();break;case"offer":s.onOffer(a);break;case"answer":s.onAnswer(a);break;case"new-ice-candidate":s.onCandidate(a);break;case"await-offer":t("active",n({},c)),s.restart();break;case"active":for(var r in a){var o=i.active.remote?i.active.remote[r]:null;o&&o(a[r])}}},enable:function(e,i){var a=s.enable(e,i);return a.then((function(){c[e]=i})).catch((function(){c[e]=r[e]=!1})).finally((function(){t("active",n({},c))})),a},end:function(){s&&s.end()}}}(this.SendSignal.bind(this),this.app.config.rtcConfig||null,{local:{audio:a[1],video:r[1]},remote:{audio:a[0],video:r[0]},active:{remote:{video:function(t){return i.LocalState.remoteVideo=t},audio:function(t){return i.LocalState.remoteAudio=t}}},end:function(){return i.EndCall()}},t?e?3:1:e?2:4,{video:this.LocalState.video,audio:this.LocalState.audio},this.app.getService("locale")._)},e.prototype.EndCall=function(){this.SetFullscreen(!1),this.getParam("state",!0).callStatus=this.callStatuses.drop,this.Phone?(this.Phone.end(),this.Phone=null,this.Back.updateCall(this.State.callId,this.callStatuses.end)):this.Back.updateCall(this.State.callId,this.callStatuses.ignore)},e.prototype.AcceptCall=function(){this.Back.updateCall(this.State.callId,this.callStatuses.accept)},e.prototype.RejectCall=function(){this.getParam("state",!0).callStatus=this.callStatuses.drop,this.Back.updateCall(this.State.callId,this.callStatuses.reject)},e.prototype.SendSignal=function(t,e){if(this.app)return"string"!=typeof e&&(e=JSON.stringify(e)),this.Back.signalCall(t,e)},e.prototype.EnableAudio=function(t){var e=this,i=t?this.LocalState.audio=!this.LocalState.audio:this.LocalState.audio;this.Phone&&this.Phone.enable("audio",i).catch((function(){e.LocalState.audio=!1,e.$$("audio-toggle").setValue(!1)}))},e.prototype.EnableVideo=function(t){var e=this,i=t?this.LocalState.video=!this.LocalState.video:this.LocalState.video;this.Phone&&this.Phone.enable("video",i).catch((function(){e.LocalState.video=!1,e.$$("video-toggle").setValue(!1)})).finally((function(){e.ShowVideo()}))},e.prototype.CheckVideoVisibility=function(){var t=this.LocalState.remoteVideo,e=this.LocalState.video,i=["none","none","none"];t?i=e?["none","block","block"]:["block","none","block"]:e&&(i=["none","block","none"]),[this.localAvatar,this.localVideo,this.remoteVideo].forEach((function(t,e){t.style.display=i[e]}))},e.prototype.UpdateCallTime=function(t){this.time=t,this.fullscreen?this.fullscreen.queryView({localId:"video-timer"}).refresh():this.$$("audio-timer").isVisible()?this.$$("audio-timer").refresh():this.$$("video-timer").isVisible()&&this.$$("video-timer").refresh()},e.prototype.HandleCallStatusChange=function(t){t==this.callStatuses.init?this.ControlVisibility("audio",this.Initiator?"outgoing":"income",this.Initiator):t==this.callStatuses.active?this.Start():t!=this.callStatuses.reject&&t!=this.callStatuses.end&&t!=this.callStatuses.ignore&&t!=this.callStatuses.lost||this.Phone&&(this.SetFullscreen(!1),this.Phone.end(),this.Phone=null)},e.prototype.ShowVideo=function(){if(this.State.callStatus==this.callStatuses.active&&!this.AfterRefresh){var t=this.LocalState.remoteVideo;!this.LocalState.video&&!t||!t?(this.SetFullscreen(!1),this.ControlVisibility("audio","active",!0)):this.fullscreen||this.ControlVisibility("video","",!0),this.CheckVideoVisibility()}},e}(h),G=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=this.app.getService("helpers");return{padding:20,margin:20,elementsConfig:{labelWidth:130,labelAlign:"right"},view:"form",localId:"form",css:"webix_chat_newchat_form",elements:[{align:"center",body:{view:"forminput",name:"avatar",body:{localId:"avatar",css:"webix_chat_form_avatar",width:130,height:130,borderless:!0,template:function(t){return i.formAvatar(t,e("Change avatar"))},onClick:{webix_chat_avatar:function(){var e=t.app.getService("upload");e.config({upload:"avatar/"+webix.uid()}),e.fileDialog()}}}}},{align:"center",body:{name:"name",localId:"name",inputAlign:"center",view:"text",width:300,placeholder:e("Chat name"),on:{onChange:function(e){t.NameChangedHandler(e)},onTimedKeyPress:function(){t.NameChangedHandler(t.$$("name").getValue())}}}},{}]}},e.prototype.init=function(){var t=this,e=this.app.getService("upload").getUploader();this.on(e,"onAfterFileAdd",(function(e){t.UpdateAvatar(e)})),this.on(e,"onUploadComplete",(function(e){t.UpdateAvatar(e)}));var i=this.getParam("state",!0),n=i.name,a=i.avatar;this.$$("form").setValues({name:n,avatar:{avatar:a}})},e.prototype.ready=function(){var t=this;webix.delay((function(){t.$$("name").focus()}))},e.prototype.UpdateAvatar=function(t){var e=this;if("client"===t.status&&t.file){var i=new FileReader;i.onload=function(){e.SetLocalAvatar(i.result)},i.readAsDataURL(t.file)}else if("server"===t.status){var n=t.value;this.$$("form").setValues({avatar:n},!0),this.AvatarChangedHandler(n),this.SetLocalAvatar(n)}},e.prototype.SetLocalAvatar=function(t){this.$$("avatar").setValues({avatar:t})},e.prototype.SetInitValues=function(){var t=this.getParam("state",!0).values.form,e=t.name,i=t.avatar;(e||i)&&this.$$("form").setValues({name:e,avatar:{avatar:i}})},e.prototype.NameChangedHandler=function(){},e.prototype.AvatarChangedHandler=function(){},e}(h);webix.ui.datafilter.umMasterCheckox=webix.extend({refresh:function(t,e,i){e.onclick=function(){i.checked=!i.checked,e.querySelector(".webix_icon").className="webix_icon wxi-checkbox-"+(i.checked?"marked":"blank"),t.data.each((function(t){return t[i.columnId]=i.checked})),t.refresh(),t.callEvent("onCustomSave",[])}},render:function(t,e){return e.checked?"<span class='webix_icon wxi-checkbox-marked'></span>":"<span class='webix_icon wxi-checkbox-blank'></span>"}},webix.ui.datafilter.masterCheckbox);var J=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{visibleBatch:"default",margin:5,rows:[{batch:"selected",view:"template",localId:"selected",autoheight:!0,scroll:"x",template:"",borderless:!0},{view:"datatable",localId:"table",css:"webix_chat_people_table",rowHeight:60,headerRowHeight:Math.max(webix.skin.$active.barHeight-2,44),columns:this.GetColumns(),scheme:{$sort:{by:"name",dir:"asc"}},checkboxRefresh:!0,on:{onItemClick:function(e){return t.Toggle(1*e.row)},onCustomSave:function(){return t.UpdatePeopleList()}}}]}},e.prototype.init=function(){var t=this,e=this.app.getService("local").users(),i=this.$$("table");this.Users=[].concat(this.getParam("state",!0).users),this.UsersStore=new webix.DataCollection({data:[]}),this.UsersStore.data.attachEvent("onSyncApply",(function(){i.clearAll(),i.parse(t.UsersStore.data.serialize().map((function(t){return{id:t.id,name:t.name,avatar:t.avatar,status:t.status}})).filter((function(e){return e.id!==t.app.config.user}))),i.sort((function(e,i){return t.SortUsers(e,i)})),t.LoadPeopleList()})),this.UsersStore.sync(e)},e.prototype.destroy=function(){this.UsersStore.destructor(),this.UsersStore=null},e.prototype.GetColumns=function(){var t=this,e=this.app.getService("locale")._,i=this.app.getService("helpers");return[{id:"selected",header:{content:"textFilter",placeholder:e("Search"),colspan:2,prepare:function(t){return t.toLowerCase()},compare:this.GetCompare()},width:45,cssFormat:function(e,i){return i.selected?"webix_chat_row_"+(t.Users.indexOf(i.id)>=0?"group_user":"select"):""},template:function(t){return t.selected?i.checkedIcon:i.notCheckedIcon}},{id:"name",header:"",template:function(t){return i.listAvatar(t,"webix_chat_people_avatar")+t.name},fillspace:2,cssFormat:function(e,i){return i.selected?"webix_chat_row_"+(t.Users.indexOf(i.id)>=0?"group_user":"select"):""}}]},e.prototype.GetCompare=function(){return function(t,e,i){return i.name.toLowerCase().indexOf(e)>-1}},e.prototype.GetPeopleList=function(t){var e=this;return t.sort((function(t,i){return e.SortUsers(t,i)})),this.app.getService("helpers").peopleList(t,!1,this.Users)},e.prototype.SortUsers=function(t,e){var i=this.Users.indexOf(t.id),n=this.Users.indexOf(e.id);return i>=0&&n<0?1:n>=0&&i<0?-1:t.name>e.name?1:t.name<e.name?-1:0},e.prototype.Toggle=function(t){var e=this.$$("table"),i=e.getItem(t);e.updateItem(t,{selected:!i.selected}),this.UpdatePeopleList()},e.prototype.UpdatePeopleList=function(){var t=this.GetSelected();this.SetBatch(t.length?"selected":"default");var e=this.GetPeopleList(t);this.$$("selected").setHTML(e),this.getParam("state",!0).users=this.GetSelectedIds()},e.prototype.LoadPeopleList=function(){var t=this,e=this.getParam("state",!0).users.filter((function(e){return e!==t.app.config.user}));if(e&&e.length){var i=[];e.forEach((function(e){var n=t.$$("table").getItem(e);i.push(n),n.selected=!0})),this.SetBatch("selected");var n=this.GetPeopleList(i);this.$$("selected").setHTML(n)}},e.prototype.GetSelected=function(){var t=[];return this.$$("table").data.each((function(e){e.selected&&t.push(e)})),t},e.prototype.GetSelectedIds=function(){var t=[];return this.$$("table").data.each((function(e){e.selected&&t.push(e.id)})),t},e.prototype.SetBatch=function(t){t?this.getRoot().showBatch(t):this.getRoot().showBatch("default")},e}(h),W=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{view:"toolbar",height:Math.max(webix.skin.$active.toolbarHeight,46),borderless:!0,cols:[]}},e.prototype.init=function(){var t=this,e=this.getParam("state",!0);this.on(e.$changes,"toolbar",(function(){var i=e.toolbar.cols.map((function(i){return t.ButtonFactory(i,e)}));t.webix.ui(i,t.getRoot())}))},e.prototype.ButtonFactory=function(t,e){var i=this,n=this.app.getService("locale")._;switch(t){case"close":return{view:"icon",icon:"wxi-close",hotkey:"esc",width:Math.max(webix.skin.$active.inputHeight,38),click:function(){e.cursor=0}};case"back":return{view:"icon",icon:"chi-back",width:Math.max(webix.skin.$active.inputHeight,38),hotkey:"esc",click:function(){e.cursor=e.cursor-1}};case"start":return{view:"icon",icon:"chi-back",width:Math.max(webix.skin.$active.inputHeight,38),hotkey:"esc",click:function(){i.app.callEvent("wizardStart",[])}};case"label":return{view:"label",css:"webix_chat_wizard_title",labelAlign:"center",label:"function"==typeof e.toolbar.label?e.toolbar.label():e.toolbar.label};case"edit":return{view:"icon",icon:"wxi-pencil",width:Math.max(webix.skin.$active.inputHeight,38),batch:"m1",click:function(){e.cursor=e.cursor+1}};case"save":return{batch:"m2",view:"button",label:n("Save"),hotkey:"enter",width:130,css:"webix_primary",click:function(){i.app.callEvent("wizardSave",[])}}}},e}(h),K=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return this.Compact=this.getParam("compact",!0),{view:"window",modal:!0,move:!0,fullscreen:this.Compact,position:"center",width:450,height:600,borderless:!0,head:W,body:{$subview:!0}}},e.prototype.init=function(){var t=this,e=this.getParam("id")||0,i=e?this.app.getService("local").chats().getItem(e):{id:0,name:"",users:[],avatar:""},n=H({cursor:1,toolbar:{label:"",cols:[]},chat:i.id,name:i.name,avatar:i.avatar,users:[].concat(i.users),group:!i.direct_id});this.setParam("state",n);var a=this.stages();this.on(n.$changes,"cursor",(function(e){webix.delay((function(){a[e]?(t.show(a[e][0]),n.toolbar=a[e][1]):t.Close()}))})),this.on(this.app,"wizardSave",(function(){t.Save&&(t.Save(),t.Close())}))},e.prototype.Close=function(){this.show("_hidden",{target:"top"})},e}(h),Y=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.init=function(){var e=this;return this.on(this.app,"wizardSave",(function(){return e.Save()})),t.prototype.init.call(this)},e.prototype.Save=function(){var t=this.getParam("state",!0),e=this.app.getService("operations"),i=this.$$("form").getValues();e.updateChat(t.chat,i.name,i.avatar.avatar),t.$batch({name:i.name,avatar:i.avatar.avatar,cursor:1})},e}(G),Z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.stages=function(){var t=this,e=this.app.getService("locale")._;return[null,["./chat.info.info",{label:function(){return t.getParam("state").name},cols:["close","label","edit"]}],["./chat.info.form",{label:'<span class="webix_chat_wizard_title2">'+e("Edit chat")+"</span>",cols:["back","label","save"]}],["./chat.info.people",{label:'<span class="webix_chat_wizard_title2">'+e("Add members")+"</span>",cols:["start","label","save"]}]]},e.prototype.init=function(){var e=this;t.prototype.init.call(this),this.on(this.app,"leaveChatClick",(function(){e.LeaveChat()}))},e.prototype.LeaveChat=function(){var t=this,e=this.app.getService("locale")._;webix.confirm({title:e("Leave chat"),ok:e("Leave"),cancel:e("Cancel"),text:e("Are you sure to leave this chat?")}).then((function(){t.app.getService("operations").leaveChat(t.getParam("state").chat),t.Close()}))},e}(K),Q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=this.getParam("state",!0),n=this.app.getService("helpers");this.ShowAll=!1,this.MemberListMaxCount=3,this.CanAddUsers=i.group;var a={localId:"avatar",css:"webix_chat_form_avatar",width:130,height:130,borderless:!0,template:function(t){return n.formAvatar(t,e("Avatar"))},data:{avatar:i.avatar}},r={view:"list",localId:"members",css:"webix_chat_list",borderless:!0,autoheight:!0,type:{height:60,template:function(e){return t.ListTemplate(e)},text:function(t){return t.replace(/<[^>]*>/g,"")}},onClick:{webix_chat_list_item_delete:function(e,i){return t.DeleteMemberClickHandler(i)}}},o={view:"button",type:"icon",width:150,height:Math.max(webix.skin.$active.inputHeight,38),icon:"wxi-plus",label:"Add members",click:function(){return i.cursor=3}},s={view:"button",css:"webix_chat_delete_button",label:e("Leave chat"),width:130,click:function(){return t.LeaveChat()}},c=[{type:"form",cols:[{},a,{}]},{type:"form",rows:[{cols:[{view:"label",label:e("Members")+" ("+i.users.length+")"},o]},r,{localId:"showAllButton",hidden:!0,autoheight:!0,borderless:!0,view:"template",template:'<span class="webix_chat_show_all_btn">'+e("Show all members")+"</span>",css:"webix_chat_show_all_tmpl",onClick:{webix_chat_show_all_btn:function(){return t.ShowAllMembers(i.users)}},inputWidth:150}]},{}];return i.group&&c.push({type:"form",padding:{top:0},cols:[s,{}]}),{view:"form",type:"clean",scroll:!0,borderless:!0,elements:c}},e.prototype.init=function(){var t=this,e=this.getParam("state",!0);this.$$("members")&&this.InitMembersList(e.users),this.on(e.$changes,"users",(function(e){return t.Filter(e)}))},e.prototype.InitMembersList=function(t){var e=this,i=this.app.getService("local"),n=this.$$("members");n.data.attachEvent("onSyncApply",(function(){n.data.sort((function(t,i){return e.Sort(t,i)}),"asc"),e.Filter(t)})),n.sync(i.users())},e.prototype.ListTemplate=function(t){var e=this.app.getService("locale")._,i=t.id==this.app.config.user?" (<span class='webix_chat_list_you_text'>"+e("You")+"</span>)":"";return this.app.getService("helpers").listAvatar(t)+t.name+i+this.DeleteButtonTemplate(t)},e.prototype.DeleteButtonTemplate=function(t){var e="";return t.id!=this.app.config.user&&this.CanAddUsers&&(e="<button type='button' class='webix_icon_button webix_chat_list_item_delete'><span class='webix_icon wxi-close'></span></button>"),e},e.prototype.Sort=function(t,e){return e.id==this.app.config.user?1:t.id==this.app.config.user?-1:t.name>e.name?1:-1},e.prototype.ShowAllMembers=function(t){this.ShowAll=!0,this.Filter(t),this.$$("showAllButton").hide()},e.prototype.Filter=function(t){var e=this;this.MemberListCount=0,this.$$("members").data.filter((function(i){var n=i.direct_id==i.id,a=t&&t.indexOf(i.id)>-1,r=n||a;return r&&!e.ShowAll&&e.MemberListCount++,r&&e.MemberListCount<=e.MemberListMaxCount})),this.MemberListCount>this.MemberListMaxCount&&this.$$("showAllButton").show()},e.prototype.DeleteMemberClickHandler=function(t){var e=this,i=this.app.getService("locale")._,n=this.app.getService("operations");webix.confirm({title:i("Delete member"),ok:i("Delete"),cancel:i("Cancel"),text:i("Are you sure to delete this member?")}).then((function(){var i=e.getParam("state",!0);i.users=i.users.filter((function(e){return e!=t})),n.setUsers(i.chat,i.users)}))},e.prototype.LeaveChat=function(){var t=this,e=this.app.getService("locale")._;webix.confirm({title:e("Leave chat"),ok:e("Leave"),cancel:e("Cancel"),text:e("Are you sure to leave this chat?")}).then((function(){var e=t.app.getService("operations"),i=t.getParam("state",!0);e.leaveChat(i.chat),i.cursor=0}))},e}(h),X=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.init=function(){var e=this,i=this.getParam("state",!0);return this._users=[].concat(i.users),this.on(this.app,"wizardStart",(function(){return e.Back()})),this.on(this.app,"wizardSave",(function(){return e.Save()})),t.prototype.init.call(this)},e.prototype.Save=function(){var t=this.getParam("state",!0);this.app.getService("operations").setUsers(t.chat,t.users),t.cursor=1},e.prototype.Back=function(){this.getParam("state",!0).$batch({cursor:1,users:this._users})},e}(J),tt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.stages=function(){return[null,["./chat.common.people",{label:'<span class="webix_chat_wizard_title2">'+(0,this.app.getService("locale")._)("Add members")+"</span>",cols:["close","label","save"]}]]},e.prototype.Save=function(){var t=this.app,e=this.getParam("state");e.users.length&&t.getService("operations").setUsers(e.chat,e.users)},e}(K),et=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var e=this,i=this.app.getService("locale")._,n=t.prototype.config.call(this,!0),a={view:"button",localId:"next",type:"icon",hotkey:"enter",icon:"chi-next",css:"webix_primary",label:'<span class="webix_chat_next_text">'+i("People")+"</span>",width:160,disabled:!0,height:Math.max(webix.skin.$active.inputHeight,38),align:"center",click:function(){e.ShowNextPage()}};return n.elements.push({align:"right",body:a}),n},e.prototype.ShowNextPage=function(){var t=this.getParam("state",!0),e=this.$$("form").getValues();t.name=e.name,t.avatar=e.avatar.avatar,t.cursor=t.cursor+1},e.prototype.NameChangedHandler=function(t){var e=this.$$("next");t?e.enable():e.disable()},e}(G),it=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.stages=function(){var t=this.app.getService("locale")._;return[null,["./chat.new.form",{label:'<span class="webix_chat_wizard_title1">'+t("New chat")+"</span>",cols:["close","label"]}],["./chat.common.people",{label:'<span class="webix_chat_wizard_title2">'+t("Add members")+"</span>",cols:["back","label","save"]}]]},e.prototype.Save=function(){var t=this.app,e=this.getParam("state"),i=e.name,n=e.avatar,a=e.users;a&&a.length&&t.getService("operations").addGroupChat(i,n,a).then((function(e){return t.callEvent("showChat",["chat",e])}))},e}(K),nt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{view:"list",localId:"list",select:!0,css:"webix_chat_list",type:{height:60,template:function(e,i){return t.ListTemplate(e,i)},text:function(t){return t.replace(/<[^>]*>/g,"")}}}},e.prototype.InitSelf=function(t,e){var i=this,n=this.$$("list");n.data.attachEvent("onSyncApply",(function(){i.ApplySearchValue(),i.SyncHandler()})),n.sync(t,e||null),n.attachEvent("onAfterSelect",(function(t){i.ShowChat(t)})),this.on(this.app.getState().$changes,"search",(function(t){i.Find(t)}))},e.prototype.SyncHandler=function(){},e.prototype.ShowChat=function(){},e.prototype.ListTemplate=function(t){return t.name},e.prototype.EscapeRegExp=function(t){return t.replace(/[[\]{}()*+?.\\^$|]/g,"\\$&")},e.prototype.ApplySearchValue=function(){var t=this.app.getState().search;t&&this.Find(t)},e.prototype.Find=function(t){var e=this,i=this.$$("list");this.EscapedSearchText=this.EscapeRegExp(t||""),t?(t=t.toLowerCase(),i.filter((function(i){return e.SearchCompare(t,i)}))):i.filter()},e.prototype.SearchCompare=function(t,e){return e.name.toLowerCase().indexOf(t)>-1},e.prototype.Select=function(t){var e=this.$$("list");t!=e.getSelectedId()&&e.getItem(t)&&e.select(t)},e}(h),at=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var e=this,i="limited"===this.app.config.mode,n=this.app.getService("locale")._;return{type:"clean",rows:[t.prototype.config.call(this),{padding:9,rows:[{view:"button",type:"icon",icon:"wxi-plus",css:"webix_chat_add_button",height:Math.max(webix.skin.$active.inputHeight,38),label:n("New chat"),click:function(){return e.app.callEvent("newChat",[])},hidden:i}]}]}},e.prototype.init=function(){var t=this,e=this.app.getParam("state",!0),i=this.app.getService("local").chats();this.InitSelf(i),i.waitData.then((function(){t.on(e.$changes,"chatId",(function(e){e?t.Select(e):t.$$("list").unselectAll()}))}))},e.prototype.ShowChat=function(t){this.app.callEvent("showChat",["chat",1*t])},e.prototype.ListTemplate=function(t,e){var i=this.app.getService("locale")._,n=this.app.getService("helpers"),a="";if(a+=n.listAvatar(t),a+="<div class='webix_chat_listitem_block'>",a+="<div class='webix_chat_listitem_name'>"+n.addTextMark(t.name,this.EscapedSearchText)+"</div>",t.date&&(a+="<span class='webix_chat_listitem_date'>"+n.dateChatFormat(t.date)+"</span>"),t.unread_count){var r="webix_chat_listitem_number";t.unread_count>9&&(r+=" webix_chat_listitem_number_wide"),a+="<span class='"+r+"'>"+t.unread_count+"</span>"}if(t.message_type){switch(a+="<div class='webix_chat_listitem_message'>",t.message_type){case 900:a+=i("Ended call")+" ("+t.message+")";break;case 901:a+=i("Rejected call");break;case 902:a+=i("Missed call")}a+="</div>"}else t.message&&(a+="<div class='webix_chat_listitem_message'>",a+=e.text(t.message),a+="</div>");return a+"</div>"},e}(nt);webix.protoUI({name:"chat-search",$cssName:"search",on_click:{webix_input_icon:function(t){t.target.className.indexOf(this.config.closeIcon)>-1?(this.getInputNode().focus(),this.setValue(""),this.callEvent("onCloseIconClick",[t]),this.hideCloseIcon()):(this.getInputNode().focus(),this.callEvent("onSearchIconClick",[t]))}},setIcon:function(t){var e=this.$view.getElementsByClassName("webix_input_icon");e.length&&(e[0].className="webix_input_icon "+t)},showCloseIcon:function(){this.setIcon(this.config.closeIcon)},hideCloseIcon:function(){this.setIcon(this.config.icon)},defaults:{closeIcon:"wxi-close"}},webix.ui.search);var rt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;return{css:"webix_chat_sidebar",width:320,type:"clean",rows:[{view:"tabbar",css:"webix_chat_tabbar",height:52,bottomOffset:0,options:[{value:e("Chats"),id:"chats"},{value:e("Users"),id:"users"}],on:{onChange:function(e){return t.ShowPanel(e)}}},{padding:9,rows:[{view:"chat-search",localId:"search",height:Math.max(webix.skin.$active.inputHeight,38),placeholder:e("Search")}]},{$subview:!0,name:"left"}]}},e.prototype.init=function(){var t=this;this.State=this.getParam("state",!0),this.ShowPanel("chats"),this.$$("search").attachEvent("onTimedKeyPress",(function(){t.State.search=t.$$("search").getValue()})),this.$$("search").attachEvent("onChange",(function(){t.State.search=t.$$("search").getValue()})),this.on(this.State.$changes,"search",(function(e){e?t.$$("search").showCloseIcon():(t.$$("search").setValue(""),t.$$("search").hideCloseIcon())}))},e.prototype.ShowPanel=function(t){this.State.search="",this.show("./"+t,{target:"left"})},e}(h),ot=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{view:"sidemenu",width:320,position:"left",state:function(e){e.left=t.Parent.left,e.top=t.Parent.top,e.height=t.Parent.height},body:rt}},e.prototype.init=function(){var t=this;this.on(this.app,"top:navigation",(function(){t.getRoot().hide()}))},e.prototype.Show=function(t){var e=this;this.getRoot().isVisible()||(this.Parent=t,this.webix.delay((function(){return e.getRoot().show()})))},e}(h),st=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.config,i=this.app.getService("locale")._;this.Compact=this.getParam("compact",!0);var n=e.mode;this.Limited="single"===n||"limited"===n;var a=Math.max(webix.skin.$active.inputHeight,38);return{view:"toolbar",localId:"toolbar",visibleBatch:"active",height:50,css:"webix_chat_toolbar",padding:{right:5},elements:[{view:"icon",icon:"webix_icon chi-menu",click:function(){return t.app.callEvent("showSidebar",[])},hidden:!this.Compact||"single"===n},{view:"template",localId:"chatTitle",css:"webix_chat_toolbar_tmpl",name:"chatTitle",borderless:!0,template:function(e){return t.TitleTemplate(e)},onClick:{webix_chat_title:function(){t.ChatInfoHandler()}}},{view:"icon",batch:"active",icon:"chi-video",tooltip:i("Start call"),localId:"call",width:a,click:function(){t.StartCallHandler()}},{view:"icon",batch:"active",icon:"chi-account-plus",tooltip:i("Add members"),width:a,click:function(){t.NewMembersHandler()}},{view:"icon",batch:"active",icon:"wxi-dots",width:a,click:function(e,i){t.ToggleMenu(i)}}]}},e.prototype.init=function(){var t=this,e=this.getParam("state",!0);this.State=e,this.app.getService("local").chats().data.attachEvent("onStoreUpdated",(function(i){i&&i!=e.chatId||t.Refresh()})),this.on(e.$changes,"*",(function(){t.Refresh()})),this.InitMenu()},e.prototype.Refresh=function(){var t=this.State;if(!this.getRoot())return!1;var e,i=this.app.getService("local");t.chatId?e=i.chats().getItem(t.chatId):e=i.users().getItem(t.userId);e=e||{},this.$$("chatTitle").setValues(e),e.direct_id&&this.app.config.calls?this.$$("call").show():this.$$("call").hide();var n=this.$$("toolbar");t.chatId&&!this.Limited?n.showBatch("active"):n.showBatch("inactive")},e.prototype.TitleTemplate=function(t){var e=this.app.getService("locale")._,i=this.app.getService("helpers"),n="";if(t.name)if(n+=i.listAvatar(t,"webix_chat_toolbar_avatar"),t.users){var a=t.users.length+" "+e("members");n+="<div class='webix_chat_title'>",t.direct_id?n+='<span class="webix_chat_messages_chat_name">'+t.name+"</span>":n+='<div class="webix_chat_messages_groupchat_name">'+t.name+'</div><div class="webix_chat_messages_groupchat_members">'+a+"</div>",n+="</div>"}else n+='<span class="webix_chat_messages_user_name">'+t.name+"</span>";return n},e.prototype.ToggleMenu=function(t){this.ToolbarMenu.isVisible()?this.ToolbarMenu.hide():this.ToolbarMenu.show(t.target,{pos:"left",y:30,x:10})},e.prototype.InitMenu=function(){var t=this;return this.ToolbarMenu=this.ui({view:"contextmenu",autowidth:!0,point:!1,data:this.GetMenuData(),on:{onItemClick:function(e){t.ToolbarMenu.callEvent("onBeforeMenuAction",[e])&&"info"==e&&t.ChatInfoHandler()}}}),this.ToolbarMenu},e.prototype.GetMenuData=function(){return[{id:"info",value:(0,this.app.getService("locale")._)("Chat info")}]},e.prototype.ChatInfoHandler=function(){this.State.chatId&&!this.Limited&&this.app.callEvent("chatInfo",[this.State.chatId])},e.prototype.NewMembersHandler=function(){this.app.callEvent("newMembers",[this.State.chatId])},e.prototype.StartCallHandler=function(){this.app.callEvent("startCall",[this.State.userId||this.State.chatId,this.State.chatId||0])},e}(h),ct=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;this.Helpers=this.app.getService("helpers"),this.State=this.getParam("state",!0);var e={view:"comments",sendAction:"enter",localId:"comments",currentUser:this.app.config.user,users:new webix.DataCollection({data:[],scheme:{$init:function(t){t.value=t.name,t.image=t.avatar}}}),listItem:{templateText:function(e){return t.MessageTemplateText(e)},templateMenu:function(e){return t.MessageTemplateMenu(e)},templateUser:function(e){return t.MessageTemplateUser(e)},templateAvatar:function(e){return t.MessageTemplateAvatar(e)},templateDate:function(e){return t.MessageTemplateDate(e)}}};return{rows:[st,e]}},e.prototype.init=function(){var t=this,e=this.Comments=this.$$("comments");this.Local=this.app.getService("local"),this.Back=this.app.getService("backend");var i=this.Back.pubsub();this.Ops=this.app.getService("operations"),e.getUsers().sync(this.Local.users()),e.attachEvent("onAfterAdd",(function(i){var n=e.getItem(i);if(!n.chat_id){var a=t.State.userId,r=n.text.replace(/</g,"&lt;");r!==n.text&&e.updateItem(i,{text:r}),t.State.chatId?(t.AddMessage(t.State.chatId,n.text,i),t.ScrollToBottom()):a&&(e.disable(),t.Ops.addChat(a).then((function(e){return t.AddMessage(e,n.text,i)})).then((function(){return t.app.callEvent("showChat",["user",a])})))}})),e.attachEvent("onBeforeDelete",(function(i){return t.IsUsersMessage(e.getItem(i))&&t.Ops.removeMessage(i),!0})),e.attachEvent("onDataUpdate",(function(e,i){t.IsUsersMessage(i)&&t.Ops.updateMessage(e,i.text)})),this.on(this.app,"showChat",(function(){var i=t.Local.chats();i.waitData.then((function(){t.getRoot()&&t.FilterUsers(e.getUsers(),i,t.State.chatId,t.State.userId)}))})),this.on(i,"messages",(function(i){var n=i.op,a=i.origin,r=i.msg;if(r.chat_id==t.State.chatId)switch(n){case"add":r.date=new Date(r.date),e.exists(a)?(e.queryView("list").data.changeId(a,r.id),e.updateItem(r.id,r)):e.exists(r.id)||(e.add(r),t.ScrollToBottom());break;case"remove":e.exists(r.id)&&e.remove(r.id);break;case"update":r.date=new Date(r.date),e.exists(r.id)&&e.updateItem(r.id,r)}})),this.on(this.State.$changes,"chatId",(function(){t.LoadChat(t.State.chatId,t.State.userId)}))},e.prototype.IsUsersMessage=function(t){return t.user_id==this.app.config.user&&(!t.type||t.type<900)},e.prototype.AddMessage=function(t,e,i){var n=this;return this.Ops.addMessage(t,i,e).then((function(t){n.Comments.exists(i)&&n.Comments.queryView("list").data.changeId(i,t.id)}))},e.prototype.ScrollToBottom=function(){var t=this.$$("comments").queryView("list");t.showItem(t.getLastId())},e.prototype.LoadChat=function(t,e){var i=this,n=this.$$("comments");n.clearAll(),t||e?(n.enable(),t&&this.Local.messages(t).then((function(e){i.getRoot()&&(n.parse(e),i.Ops.resetCounter(t),i.ScrollToBottom())})),this.Focus()):n.disable()},e.prototype.FilterUsers=function(t,e,i,n){var a=this,r=i?e.getItem(i):null;t.data.filter((function(t){return i?r&&r.users.indexOf(t.id)>=0&&t.id!=a.app.config.user:t.id==n}))},e.prototype.Focus=function(){var t=this;webix.delay((function(){t.getRoot()&&t.Comments.focus()}))},e.prototype.MessageTemplateText=function(t){var e=t.text,i=t.type;if(t.type){var n=this.State.userId==t.user_id,a="chi-arrow-"+(n?"bottom-left":"top-right"),r=this.app.getService("locale")._,o=void 0;switch(i){case 900:o=r(n?"Incoming call":"Outgoing call");break;case 901:o=r("Rejected call");break;case 902:o=r("Missed call")}e="<span class = 'webix_chat_call_type "+a+" webix_chat_call_type_"+this.Back.callMessages[i]+"'></span><div class = 'webix_chat_call_message'>"+o+"<p>"+e+"</p></div>"}return"<div class = 'webix_comments_message'>"+e+"</div>"},e.prototype.MessageTemplateAvatar=function(t){var e="<div class='webix_chat_list_avatar'>",i=this.Comments.getUsers(),n=i&&i.exists(t.user_id)?i.getItem(t.user_id):{};return n.status&&(e+=this.Helpers.status(n)),e+=this.Helpers.avatar(n),e+="</div>"},e.prototype.MessageTemplateUser=function(t){var e=this.Comments.getUsers();return"<span class = 'webix_comments_name'>"+((e&&e.exists(t.user_id)?e.getItem(t.user_id):{}).name||"")+"</span>"},e.prototype.MessageTemplateMenu=function(t){return this.Comments.config.readonly||t.type>=900?"":"<span class='webix_icon wxi-dots webix_comments_menu'></span>"},e.prototype.MessageTemplateDate=function(t){return t.date?"<span class='webix_comments_date'>"+this.Helpers.dateChatFormat(t.date)+"</span>":""},e}(h);webix.protoUI({name:"r-layout",sizeTrigger:function(t,e,i){this._compactValue=i,this._compactWidth=t,this._compactHandler=e,this._checkTrigger(this.$view.width,i)},_checkTrigger:function(t,e){return!this._compactWidth||!(t<=this._compactWidth&&!e||t>this._compactWidth&&e)||(this._compactWidth=null,this._compactHandler(!e),!1)},$setSize:function(t,e){if(this._checkTrigger(t,this._compactValue))return webix.ui.layout.prototype.$setSize.call(this,t,e)}},webix.ui.layout);var ut=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t="single"===this.app.config.mode,e=this.getParam("forceCompact"),i=void 0!==e||t;return i&&this.setParam("compact",e||t),this.Compact=this.getParam("compact"),{view:i?"layout":"r-layout",id:"main",rows:[{cols:this.Compact?[{$subview:!0,name:"center"}]:[rt,{$subview:!0,name:"center"},{$subview:"_hidden",name:"panel"}]},{$subview:!0,name:"top",popup:!0}]}},e.prototype.init=function(){var t=this,e=this.app.getService("local"),i=this.getRoot();i.sizeTrigger&&i.sizeTrigger(this.app.config.compactWidth,(function(e){return t.SetCompactMode(e)}),!!this.Compact),this.ShowDefaultChat(),this.on(this.app,"showSidebar",(function(){return t.ShowSidebar()})),this.on(this.app,"showChat",(function(i,n){var a=null;if("user"===i){a=n;var r=e.chats().find((function(t){return t.direct_id==n}),!0);n=r?r.id:null}else{(r=e.chats().getItem(n)).direct_id&&(i="user",a=r.direct_id)}t.ShowChat(i,n,a)})),this.on(this.app,"leaveChat",(function(e){t.LeaveChat(e)})),this.on(this.app,"removeChatMember",(function(e){t.LeaveChat(e,!0)})),this.on(this.app,"newChat",(function(){t.ShowChatWindow()})),this.on(this.app,"chatInfo",(function(e){t.ShowChatInfo(e)})),this.on(this.app,"newMembers",(function(e){t.ShowNewMembersWindow(e)})),this.on(this.app,"startCall",(function(e,i){t.StartCall(e,i)}));var n=this.getParam("state");this.on(n.$changes,"callId",(function(e){e?t.Compact?t.show("./call.panel",{target:"center"}):(t.show("./call.panel",{target:"panel"}),t.show("./messages",{target:"center"})):(t.show("./messages",{target:"center"}),t.Compact||t.show("_hidden",{target:"panel"}))}));var a=this.app.getService("backend"),r=a.pubsub(),o=a.callStatuses;this.on(r,"signal",(function(e){if("active"===e.type)n.timer||a.callInfo().then((function(e){var i=new Date(e.start),a=Math.max(new Date,i);n.time=Math.floor((a-i)/1e3),t.CallTimer()}));else if("connect"===e.type){var i=JSON.parse(e.msg);if(i.devices)return void(-1==i.devices.indexOf(t.app.config.device)&&t.EndCall());if(n.callId&&i.id!=n.callId)return void(i.status<900&&a.updateCall(i.id,o.reject));i.start&&!n.timer&&t.CallTimer(),i.status==o.init&&(n.callChatId=n.chatId);var r=i.users,s=i.id,c=i.status;i.status==o.end||i.status==o.reject||i.status==o.ignore||i.status==o.lost?t.EndCall():n.$batch({callId:s,callStatus:c,callUsers:r})}}))},e.prototype.EndCall=function(){var t=this.getParam("state");t.timer&&clearInterval(t.timer),t.$batch({callId:0,callStatus:"",callUsers:[],callChatId:null,timer:null,time:null})},e.prototype.ShowDefaultChat=function(){var t=this,e=this.getParam("state"),i=this.app.getService("local").chats();i.waitData.then((function(){e.chatId||(i.count()?e.chatId=i.getFirstId():t.Compact&&t.ShowSidebar())}))},e.prototype.ShowChat=function(t,e,i){this.getParam("state").$batch({chatId:e,chatType:t,userId:i}),this.show("_hidden",{target:"top"})},e.prototype.ShowChatWindow=function(){this.show("chat.new",{target:"top"})},e.prototype.ShowChatInfo=function(t){this.show("chat.info",{target:"top",params:{id:t}})},e.prototype.ShowNewMembersWindow=function(t){this.show("chat.members",{target:"top",params:{id:t}})},e.prototype.LeaveChat=function(t,e){var i=this.app.getService("locale")._,n=this.getParam("state");t===n.chatId&&(e&&webix.alert(i("You have been removed from the group")),n.$batch({chatId:0,chatType:"",userId:0}))},e.prototype.SetCompactMode=function(t){var e=this;webix.delay((function(){e.setParam("compact",t),e.refresh()}))},e.prototype.ShowSidebar=function(){this.SideMenu&&this.SideMenu.getRoot()||(this.SideMenu=this.ui(ot));var t=this.$$("main").$view.getBoundingClientRect();this.SideMenu.Show(t)},e.prototype.StartCall=function(t,e){var i=this.app.getService("locale")._;this.app.getService("backend").startCall(t,e).catch((function(){webix.alert(i("Can't start the call"))}))},e.prototype.CallTimer=function(){var t=this,e=this.getParam("state");e.time||(e.time=0),e.timer=setInterval((function(){t.app.callEvent("updateCallTime",[++e.time])}),1e3)},e}(h),ht=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.init=function(){var t=this.app.getService("local").users();this.InitSelf(t)},e.prototype.SyncHandler=function(){var t=this;this.$$("list").data.filter((function(e){return e.id!=t.app.config.user})),this.$$("list").data.silent((function(){this.sort("name","asc")}))},e.prototype.ShowChat=function(t){this.app.callEvent("showChat",["user",1*t])},e.prototype.ListTemplate=function(t){var e=this.app.getService("helpers");return e.listAvatar(t)+e.addTextMark(t.name,this.EscapedSearchText)},e}(nt),lt={JetView:h};lt["call/panel"]=q,lt["chat/common/form"]=G,lt["chat/common/people"]=J,lt["chat/common/toolbar"]=W,lt["chat/common/window"]=K,lt["chat/info/form"]=Y,lt["chat/info"]=Z,lt["chat/info/info"]=Q,lt["chat/info/people"]=X,lt["chat/members"]=tt,lt["chat/new/form"]=et,lt["chat/new"]=it,lt.chats=at,lt["compact/sidemenu"]=ot,lt.list=nt,lt.messages=ct,lt["messages/toolbar"]=st,lt.sidebar=rt,lt.top=ut,lt.users=ht;var pt=function(){function t(t){this.app=t,this._messages={},this._subs=[]}return t.prototype.users=function(){var t=this;if(!this._users){var e=this.app.getService("backend");this._users=new webix.DataCollection({}),e.users().then((function(e){return t._users.parse(e)})),this._subs.push(e.pubsub().attachEvent("users",(function(e){var i,n=e.op,a=e.user_id,r=e.data;switch(n){case"online":(i=t._users.getItem(a))&&i.status!=r&&t._users.updateItem(a,{status:r})}})))}return this._users},t.prototype.chats=function(){var t=this,e=this.app.getState();if(!this._chats){this._chats=new webix.DataCollection({scheme:{$change:function(e){if(e.date&&"string"==typeof e.date&&(e.date=new Date(e.date)),e.direct_id){var i=t.users().getItem(e.direct_id);e.name||(e.name="PM: "+i.name),e.avatar||(e.avatar=i.avatar)}},$sort:{by:"date",dir:"desc",as:"date"}}});var i=this.app.getService("backend");Promise.all([i.chats(),this.users().waitData]).then((function(e){t._chats.parse(e[0])})),this._subs.push(i.pubsub().attachEvent("chats",(function(e){var i,n=e.op,a=e.chat_id,r=e.data;switch(n){case"add":case"update":if(-1==r.users.indexOf(t.app.config.user))return void(t._chats.exists(a)&&(t.app.callEvent("removeChatMember",[a]),t._chats.remove(a)));t._chats.exists(a)?(i={name:r.name,avatar:r.avatar,users:r.users},r.direct_id||(i.direct_id=0),t._chats.updateItem(a,i)):t._chats.add(r,0);break;case"message":t._chats.updateItem(a,{message:r.message,message_type:r.message_type,date:new Date(r.date)})}}))),this._subs.push(i.pubsub().attachEvent("messages",(function(n){var a,r=n.op,o=n.msg;switch(r){case"add":(a=t._chats.getItem(o.chat_id))&&(e.chatId!=a.id?t._chats.updateItem(a.id,{message:o.text,message_type:o.type,unread_count:a.unread_count+1,date:o.date}):(t._chats.updateItem(a.id,{message:o.text,message_type:o.type,date:o.date}),i.resetCounter(a.id)),t._chats.getIndexById(a.id)&&t._chats.moveTop(a.id))}})))}return this._chats},t.prototype.messages=function(t){var e=this.app.getService("backend");return this._messages[t]=e.messages(t)},t}(),ft=function(){function t(t){var e=t.url,i=t.token;this._url=e,this._token=i,this._mode=1,this._seed=1,this._queue=[],this.data={},this.api={},this._events={}}return t.prototype.headers=function(){return{Accept:"application/json","Content-Type":"application/json","Remote-Token":this._token}},t.prototype.fetch=function(t,e){var i={credentials:"include",headers:this.headers()};return e&&(i.method="POST",i.body=e),fetch(t,i).then((function(t){return t.json()}))},t.prototype.load=function(t){var e=this;return t&&(this._url=t),this.fetch(this._url).then((function(t){return e.parse(t)}))},t.prototype.parse=function(t){var e=t.key,i=t.websocket;for(var n in e&&(this._token=t.key),t.data)this.data[n]=t.data[n];for(var a in t.api){var r=this.api[a]={},o=t.api[a];for(var s in o)r[s]=this._wrapper(a+"."+s)}return i&&this.connect(),this},t.prototype.connect=function(){var t=this,e=this._socket;e&&(this._socket=null,e.onclose=function(){},e.close()),this._mode=2,this._socket=function(e,i,n,a){var r=i;"/"===r[0]&&(r=document.location.protocol+"//"+document.location.host+i);var o=-1!=(r=r.replace(/^http(s|):/,"ws$1:")).indexOf("?")?"&":"?";r=""+r+o+"token="+n+"&ws=1";var s=new WebSocket(r);return s.onclose=function(){return setTimeout((function(){return e.connect()}),2e3)},s.onmessage=function(i){var n=JSON.parse(i.data);switch(n.action){case"result":e.result(n.body,[]);break;case"event":e.fire(n.body.name,n.body.value);break;case"start":t._mode=3,t._send(),t._resubscribe();break;default:e.onError(n.data)}},s}(this,this._url,this._token)},t.prototype._wrapper=function(t){return function(){var e=this,i=[].slice.call(arguments),n=null,a=new Promise((function(a,r){n={data:{id:e._uid(),name:t,args:i},status:1,resolve:a,reject:r},e._queue.push(n)}));return this.onCall(n,a),3===this._mode?this._send(n):setTimeout((function(){return e._send()}),1),a}.bind(this)},t.prototype._uid=function(){return(this._seed++).toString()},t.prototype._send=function(t){var e=this;if(2!=this._mode){var i=t?[t]:this._queue.filter((function(t){return 1===t.status}));if(i.length){var n=i.map((function(t){return t.status=2,t.data}));3!==this._mode?this.fetch(this._url,JSON.stringify(n)).catch((function(t){return e.onError(t)})).then((function(t){return e.result(t,n)})):this._socket.send(JSON.stringify({action:"call",body:n}))}}else setTimeout((function(){return e._send()}),100)},t.prototype.result=function(t,e){var i={};if(t)for(var n=0;n<t.length;n++)i[t[n].id]=t[n];else for(var a=0;a<e.length;a++)i[e[a].id]={id:e[a].id,error:"Network Error",data:null};for(var r=this._queue.length-1;r>=0;r--){var o=this._queue[r],s=i[o.data.id];s&&(this.onResponse(o,s),s.error?o.reject(s.error):o.resolve(s.data),this._queue.splice(r,1))}},t.prototype.on=function(t,e){var i=this._uid(),n=this._events[t],a=!!n;return a||(n=this._events[t]=[]),n.push({id:i,handler:e}),a||3!=this._mode||this._socket.send(JSON.stringify({action:"subscribe",name:t})),{name:t,id:i}},t.prototype._resubscribe=function(){if(3==this._mode)for(var t in this._events)this._socket.send(JSON.stringify({action:"subscribe",name:t}))},t.prototype.detach=function(t){if(t){var e=t.id,i=t.name,n=this._events[i];if(n){var a=n.filter((function(t){return t.id!=e}));a.length?this._events[i]=a:(delete this._events[i],3==this._mode&&this._socket.send(JSON.stringify({action:"unsubscribe",name:i})))}}else{if(3==this._mode)for(var r in this._events)this._socket.send(JSON.stringify({action:"unsubscribe",key:r}));this._events={}}},t.prototype.fire=function(t,e){var i=this._events[t];if(i)for(var n=0;n<i.length;n++)i[n].handler(e)},t.prototype.onError=function(t){return null},t.prototype.onCall=function(t,e){},t.prototype.onResponse=function(t,e){},t}(),dt=function(){function t(t){var e=this;this.app=t;var i=new ft({url:t.config.url,token:t.config.token});this._ready=i.load().then((function(i){e._api=i.api,e._data=i.data,e._pubsub={attachEvent:function(t,e){return i.on(t,e)},detachEvent:function(t){return i.detach(t)}};var n=t.config.user=e._data.user;t.config.device=e._data.device,e._data.users.forEach((function(t){t.id===n&&(t.status=2)}))})),this.callStatuses={init:1,accept:2,active:3,drop:900,reject:901,end:902,ignore:903,lost:904},this.callMessages={900:"start",901:"reject",902:"ignore"}}return t.prototype.ready=function(){return this._ready},t.prototype.users=function(){return Promise.resolve(this._data.users)},t.prototype.chats=function(){return Promise.resolve(this._data.chats)},t.prototype.callInfo=function(){return Promise.resolve(this._data.call)},t.prototype.addChat=function(t){return this._api.chat.AddDirect(1*t)},t.prototype.messages=function(t){return this._api.message.GetAll(1*t).then((function(t){return t.forEach((function(t){return t.date=new Date(t.date)})),t}))},t.prototype.addMessage=function(t,e,i){return this._api.message.Add(e,1*t,i.toString()).then((function(t){return t.date=new Date(t.date),t}))},t.prototype.removeMessage=function(t){return this._api.message.Remove(1*t)},t.prototype.updateMessage=function(t,e){return this._api.message.Update(1*t,e)},t.prototype.resetCounter=function(t){this._api.message.ResetCounter(1*t)},t.prototype.pubsub=function(){return this._pubsub},t.prototype.addGroupChat=function(t,e,i){return this._api.chat.AddGroup(t,e,i)},t.prototype.updateChat=function(t,e,i){return this._api.chat.Update(t,e,i)},t.prototype.leave=function(t,e){return this._api.chat.Leave(t,e)},t.prototype.setUsers=function(t,e){return this._api.chat.SetUsers(t,e)},t.prototype.avatarUploadUrl=function(){return this.app.config.url+"/chat/0/avatar"},t.prototype.startCall=function(t,e){return this._api.call.Start(t,e)},t.prototype.updateCall=function(t,e){return this._api.call.SetStatus(t,e)},t.prototype.signalCall=function(t,e){return this._api.call.Signal(t,e)},t}(),vt=function(){function t(t){this._app=t,this._local=this._app.getService("local"),this._back=this._app.getService("backend")}return t.prototype.addChat=function(t){var e=this;return this._back.addChat(t).then((function(t){return e._local.chats().add(t,0),t.id}))},t.prototype.addMessage=function(t,e,i){var n=this._local.chats();return n.updateItem(t,{message:this._getMessageText(i),message_type:0,date:new Date}),n.getIndexById(t)&&n.moveTop(t),this._back.addMessage(t,i,e)},t.prototype.removeMessage=function(t){return this._back.removeMessage(t)},t.prototype.updateMessage=function(t,e){return this._back.updateMessage(t,e)},t.prototype._getMessageText=function(t){return t.substr(0,Math.min(t.length,80))},t.prototype.resetCounter=function(t){this._back.resetCounter(t);var e=this._local.chats();e.exists(t)&&e.updateItem(t,{unread_count:0})},t.prototype.addGroupChat=function(t,e,i){var n=this;return this._back.addGroupChat(t,e,i).then((function(t){return n._local.chats().add(t,0),t.id}))},t.prototype.updateChat=function(t,e,i){var n=this;return this._back.updateChat(t,e,i).then((function(e){n._local.chats().updateItem(t,e)}))},t.prototype.leaveChat=function(t){var e=this;return this._back.leave(t,this._app.config.user).then((function(){e._app.callEvent("leaveChat",[t]),e._local.chats().remove(t)}))},t.prototype.setUsers=function(t,e){var i=this;return this._back.setUsers(t,e).then((function(e){var n=i._local.chats();e.id==t?n.updateItem(t,e):(n.add(e,0),i._app.callEvent("showChat",[n,e.id]))}))},t}(),mt=function(){function t(t){this.app=t,this.initUploader()}return t.prototype.initUploader=function(){var t=this;this.uploader=webix.ui({view:"uploader",apiOnly:!0,accept:"image/*",autosend:!0,on:{onBeforeFileAdd:function(){return t.configUpload()}}})},t.prototype.config=function(t){webix.extend(this.uploader.config,t,!0)},t.prototype.getUploader=function(){return this.uploader},t.prototype.configUpload=function(){this.uploader.config.upload=this.app.getService("backend").avatarUploadUrl()},t.prototype.fileDialog=function(){this.uploader.fileDialog()},t}(),gt=function(){function t(){this.statusMap={1:"none",2:"active",3:"busy",4:"away"},this.checkedIcon="<span class='webix_icon wxi-checkbox-marked'></span>",this.notCheckedIcon="<span class='webix_icon wxi-checkbox-blank'></span>",this.dateMask="%d.%m.%Y",this.weekMask="%D",this.todayDateMask="%H:%i"}return t.prototype.status=function(t){return"<span class = 'webix_chat_status webix_chat_status_"+this.statusMap[t.status]+"'></span>"},t.prototype.listAvatar=function(t,e){var i="<div class='"+("string"==typeof e?e:"webix_chat_list_avatar")+"'>";return t.status&&(i+=this.status(t)),i+=this.avatar(t),i+="</div>"},t.prototype.initials=function(t){var e=t.match(/\b\w/g)||[];return((e.shift()||"")+(e.pop()||"")).toUpperCase()},t.prototype.avatar=function(t,e){var i="string"==typeof e?e:"webix_chat_avatar";return t.avatar?'<img alt="" class="'+i+'" src="'+t.avatar+'"/>':t.name?"<div class='"+i+"'>"+this.initials(t.name||"")+"</div>":"<div class='"+i+" webix_icon wxi-user'></div>"},t.prototype.formAvatar=function(t,e){var i="webix_chat_avatar";return t.avatar?'<img alt="" title="'+e+'" class="'+i+'" src="'+t.avatar+'"/>':"<div class='"+i+"  webix_icon chi-camera' title='"+e+"'</div>"},t.prototype.dateChatFormat=function(t){var e=this.dateMask,i=webix.Date.datePart(new Date,!0),n=webix.Date.datePart(t,!0);return webix.Date.equal(n,i)?e=this.todayDateMask:n>webix.Date.add(i,-7,"day")&&(e=this.weekMask),webix.Date.dateToStr(e)(t)},t.prototype.peopleList=function(t,e,i){var n=this,a="<ul class='webix_chat_peoplelist'>";return t.forEach((function(t){a+="<li class='webix_chat_peoplelist_item' data-id='"+t.id+"'><div class='webix_chat_peoplelist_avatar'>"+n.avatar(t)+(i&&i.indexOf(t.id)>=0?"<div class='webix_chat_group_user_marker'><span class='webix_icon wxi-check'></span></div>":"")+(e?"<div class='webix_chat_peoplelist_delete_icon'><span class='webix_icon wxi-close'></span></div>":"")+'</div><br/><span class="webix_chat_peoplelist_item_name">'+t.name+"</span></li>"})),a+="</ul>"},t.prototype.addTextMark=function(t,e){return e?t.replace(new RegExp("("+e+")","ig"),"<span class='webix_chat_search_mark'>$1</span>"):t},t.prototype.normalizeTime=function(t){t=t||0;var e=Math.floor(t/60),i=t-60*e;return(e<10?"0"+e:e)+":"+(i<10?"0"+i:i)},t}(),bt=function(t){function e(e){var i=this,a={state:H({chatId:0,chatType:null,userId:null,search:"",callStatus:0,callId:0,callUsers:[]})};e.compat&&(a.forceCompact=e.compact);var r={router:_,version:"9.0.0",debug:!0,start:"/top",mode:"full",compactWidth:650,params:a};(i=t.call(this,n(n({},r),e))||this).config.debug&&(webix.Promise=window.Promise);var o=function(t){return i.config.override&&i.config.override.get(t)||t};return i.setService("local",new(o(pt))(i)),i.setService("backend",new(o(dt))(i)),i.setService("operations",new(o(vt))(i)),i.setService("upload",new(o(mt))(i)),i.setService("helpers",new(o(gt))(i)),i.use(R,i.config.locale||{lang:"en",webix:{en:"en-US"}}),i}return i(e,t),e.prototype.render=function(e){var i=this,n=this.getService("backend");n.ready().then((function(){return n.callInfo()})).then((function(n){n&&n.id&&i.config.params.state.$batch({callId:n.id,callUsers:n.users,callStatus:n.status});t.prototype.render.call(i,e)}))},e.prototype.require=function(t,e){return"jet-views"===t?lt[e]:"jet-locales"===t?wt[e]:null},e.prototype.getState=function(){return this.config.params.state},e}(b);webix.protoUI({name:"chat",app:bt,getState:function(){return this.$app.getState()},getService:function(t){return this.$app.getService(t)},$init:function(){var t=this.$app.getState();for(var e in t)j(t,this.config,e)}},webix.ui.jetapp);var _t={Local:pt,Backend:dt,Operations:vt,Upload:mt,Helpers:gt},wt={en:{"Add members":"Add members","Are you sure to leave this chat?":"Are you sure to leave this chat?",Avatar:"Avatar","Are you sure to delete this member?":"Are you sure to delete this member?",Cancel:"Cancel","Change avatar":"Change avatar","Chat info":"Chat info","Chat name":"Chat name",Chats:"Chats","Create group":"Create group",Delete:"Delete","Delete member":"Delete member","Edit chat":"Edit chat",Leave:"Leave","Leave chat":"Leave chat",member:"member",members:"members",Members:"Members","New chat":"New chat","No people to add":"No people to add",People:"People",Save:"Save",Search:"Search","Show all members":"Show all members",Users:"Users",You:"You",Ringing:"Ringing...","Active call":"Active call","Is calling you":"Is calling you...",Accept:"Accept",Reject:"Reject","Start call":"Start call","Join call":"Join call","End call":"End call","Ended call":"Ended call","Incoming call":"Incoming call","Outgoing call":"Outgoing call","Rejected call":"Rejected call","Missed call":"Missed call","Can't start the call":"Can't start the call","Could not find your":"Could not find your","Error opening your":"Error opening your",microphone:"microphone",camera:"camera"}};t.App=bt,t.locales=wt,t.services=_t,t.views=lt,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=chat.min.js.map
